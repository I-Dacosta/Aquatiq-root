# Aquatiq Root Container System – Lokal utvikling
# Sentralisert infrastrukturstack for lokal utvikling
# Alle tjenester tilgjengelig kun fra localhost (127.0.0.1) for trygg dev

services:
  # Docker Socket Proxy – sikrere tilgang til Docker API
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: aquatiq-docker-proxy-local
    restart: unless-stopped
    env_file: [.env.local]
    environment:
      - CONTAINERS=1
      - POST=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=1
      - INFO=1
      - NETWORKS=1
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=1
      - TASKS=0
      - VOLUMES=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - aquatiq-local
      - ima-local

  # PostgreSQL 17 – felles database for lokal utvikling (ingen pgvector lenger)
  postgres:
    image: postgres:17-alpine
    container_name: aquatiq-postgres-local
    restart: unless-stopped
    env_file: [.env.local]
    environment:
      POSTGRES_USER: aquatiq
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_MULTIPLE_DATABASES: n8n,aquatiq_risk,aquatiq_dev
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_local_data:/var/lib/postgresql/data
      - ./init-multi-db.sh:/docker-entrypoint-initdb.d/init-multi-db.sh:ro
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aquatiq"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 7 – cache og kø (felles for lokal utvikling)
  redis:
    image: redis:7-alpine
    container_name: aquatiq-redis-local
    restart: unless-stopped
    env_file: [.env.local]
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_local_data:/data
      - ./redis.conf:/etc/redis/redis.conf:ro
    command: redis-server /etc/redis/redis.conf
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      # Bruker REDIS_PASSWORD fra container-miljøet
      test: ["CMD-SHELL", "redis-cli -a \"$REDIS_PASSWORD\" ping || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  # NATS – meldingskø/pub-sub (felles for lokal utvikling)
  nats:
    image: nats:2.10-alpine
    container_name: aquatiq-nats-local
    restart: unless-stopped
    command:
      - "-c"
      - "/etc/nats/nats.conf"
    env_file: [.env.local]
    environment:
      - NATS_AUTH_TOKEN=${NATS_AUTH_TOKEN}
    ports:
      - "127.0.0.1:4222:4222"
      - "127.0.0.1:8222:8222"
    volumes:
      - nats_local_data:/data
      - ./nats.conf:/etc/nats/nats.conf:ro
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Qdrant – vektordatabasen for semantisk søk / RAG (erstatter pgvector)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: aquatiq-qdrant-local
    restart: unless-stopped
    env_file: [.env.local]
    ports:
      - "127.0.0.1:6333:6333"   # HTTP API
      - "127.0.0.1:6334:6334"   # gRPC API
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Aquatiq Gateway – infrastruktur-API (lokal bruk, kun localhost)
  aquatiq-gateway:
    build: ./aquatiq-gateway
    container_name: aquatiq-gateway-local
    restart: unless-stopped
    env_file: [.env.local]
    ports:
      - "127.0.0.1:7500:7500"   # REST API
      - "127.0.0.1:50051:50051" # gRPC API
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      docker-socket-proxy:
        condition: service_started
    environment:
      # Server-oppsett
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=7500
      - SERVER_GRPCPORT=50051
      - SERVER_APIKEY=${INTEGRATION_GATEWAY_API_KEY}

      # gRPC-oppsett
      - GRPC_HOST=0.0.0.0
      - GRPC_PORT=50051
      - GRPC_TLS_ENABLED=false

      # Docker-tilkobling (via proxy)
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      - DOCKER_VERSION=1.41

      # Database-oppsett (egen gateway-DB)
      - DATABASE_POSTGRESURL=postgres://aquatiq:${POSTGRES_PASSWORD}@postgres:5432/aquatiq?sslmode=disable

      # Redis-oppsett
      - REDIS_ENABLED=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_TLS_ENABLED=false

      # Query-cache
      - CACHE_QUERY_ENABLED=true
      - CACHE_QUERY_TTL=5m
      - CACHE_QUERY_PREFIX=query

      # Lokal utvikling
      - DOMAIN=${DOMAIN}
      - LOGGING_LEVEL=debug
      - LOGGING_FORMAT=json
    volumes:
      - aquatiq_gateway_local_data:/data
      - ./backups:/backups
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7500/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # n8n – arbeidsflyt- og automasjonsmotor (valgfri, men anbefalt)
  n8n:
    image: n8nio/n8n:latest
    container_name: aquatiq-n8n-local
    restart: unless-stopped
    env_file: [.env.local]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      nats:
        condition: service_healthy
    environment:
      # n8n basisoppsett
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - WEBHOOK_URL=http://localhost:5678/
      - NODE_ENV=development
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Database-tilkobling
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=aquatiq
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # Redis for kø
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}

      # Utførelsesdata
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      # Integrasjoner
      - NATS_AUTH_TOKEN=${NATS_AUTH_TOKEN}
    ports:
      - "127.0.0.1:5678:5678"
    volumes:
      - n8n_local_data:/home/node/.n8n
      - ./workflows:/workflows:ro
    networks:
      - aquatiq-local
      - ima-local
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # pgAdmin – GUI for PostgreSQL (kun localhost)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: aquatiq-pgadmin-local
    restart: unless-stopped
    env_file: [.env.local]
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@aquatiq.com
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_DISABLE_POSTFIX=true
    ports:
      - "127.0.0.1:5050:80"
    volumes:
      - pgadmin_local_data:/var/lib/pgadmin
    networks:
      - aquatiq-local

  # RedisInsight – GUI for Redis (ARM64-kompatibel, kun localhost)
  redis-insight:
    image: redis/redisinsight:latest
    container_name: aquatiq-redis-insight-local
    restart: unless-stopped
    env_file: [.env.local]
    ports:
      - "127.0.0.1:5540:5540"
    volumes:
      - redis_insight_local_data:/data
    networks:
      - aquatiq-local

  # MinIO – objektlagring (S3 API, konsoll på 9011)
  minio:
    image: minio/minio:latest
    container_name: aquatiq-minio
    restart: unless-stopped
    env_file: [.env.local]
    ports:
      - "127.0.0.1:9010:9000"  # S3 API
      - "127.0.0.1:9011:9001"  # Web-konsoll
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=aquatiq-minio-2024
    volumes:
      - minio-data:/data
    networks:
      - aquatiq-local
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  postgres_local_data:
    driver: local
  redis_local_data:
    driver: local
  nats_local_data:
    driver: local
  qdrant-data:
    driver: local
  n8n_local_data:
    driver: local
  pgadmin_local_data:
    driver: local
  redis_insight_local_data:
    driver: local
  aquatiq_gateway_local_data:
    driver: local
  minio-data:
    driver: local

networks:
  aquatiq-local:
    name: aquatiq-local
    driver: bridge
  ima-local:
    name: ima-local
    driver: bridge
