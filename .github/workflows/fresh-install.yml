name: Fresh Installation & Full Initialization

on:
  workflow_dispatch:
    inputs:
      reset_volumes:
        description: 'Reset all Docker volumes (database, n8n, redis data)'
        required: false
        default: 'false'
        type: boolean
      reset_networks:
        description: 'Reset Docker networks'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  packages: write

jobs:
  fresh-install:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fresh Installation to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            DEPLOY_DIR="/opt/aquatiq"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            GITHUB_ACTOR="${{ github.actor }}"
            GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
            
            echo "üöÄ FRESH INSTALLATION & INITIALIZATION"
            echo "========================================"
            
            # Initialize or reset directory
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "üìÅ Creating deployment directory..."
              mkdir -p "$DEPLOY_DIR"
              cd "$DEPLOY_DIR"
              echo "üîÑ Cloning repository..."
              git clone "$REPO_URL" .
            else
              cd "$DEPLOY_DIR"
              echo "üì• Updating existing installation..."
              git fetch origin main
              git checkout main
              git reset --hard origin/main
            fi
            
            # Stop all services before fresh installation
            echo "‚èπÔ∏è  Stopping all services..."
            docker compose down 2>/dev/null || true
            
            # Reset volumes if requested
            if [ "${{ inputs.reset_volumes }}" = "true" ]; then
              echo "üóëÔ∏è  Removing volumes (data will be lost!)..."
              docker volume rm aquatiq_postgres_data aquatiq_redis_data aquatiq_n8n_data 2>/dev/null || true
              echo "‚úÖ Volumes removed - fresh database initialization will occur"
            fi
            
            # Reset networks if requested
            if [ "${{ inputs.reset_networks }}" = "true" ]; then
              echo "üóëÔ∏è  Removing networks..."
              docker network rm internal aquatiq-backend 2>/dev/null || true
              echo "‚úÖ Networks removed - will be recreated"
            fi
            
            # üîê CREATE PRODUCTION ENVIRONMENT FILE WITH GITHUB SECRETS
            echo "üîê Injecting credentials from GitHub Secrets..."
            mkdir -p "$DEPLOY_DIR/secrets"
            
            # Export GitHub Secrets to .env.production
            cat > "$DEPLOY_DIR/.env.production" << 'EOF'
            # Production Environment - Auto-generated from GitHub Secrets
            # Generated: $(date)
            
            DOMAIN=${{ secrets.DOMAIN }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            NATS_AUTH_TOKEN=${{ secrets.NATS_AUTH_TOKEN }}
            N8N_ENCRYPTION_KEY=${{ secrets.N8N_ENCRYPTION_KEY }}
            INTEGRATION_GATEWAY_API_KEY=${{ secrets.INTEGRATION_GATEWAY_API_KEY }}
            PGADMIN_EMAIL=${{ secrets.PGADMIN_EMAIL }}
            PGADMIN_PASSWORD=${{ secrets.PGADMIN_PASSWORD }}
            GRAFANA_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
            TRAEFIK_DASHBOARD_AUTH=${{ secrets.TRAEFIK_DASHBOARD_AUTH }}
            EOF
            
            # Create secret files from environment variables (using -n to avoid adding newlines)
            echo -n "${{ secrets.POSTGRES_PASSWORD }}" > "$DEPLOY_DIR/secrets/postgres_password.txt"
            echo -n "${{ secrets.REDIS_PASSWORD }}" > "$DEPLOY_DIR/secrets/redis_password.txt"
            echo -n "${{ secrets.NATS_AUTH_TOKEN }}" > "$DEPLOY_DIR/secrets/nats_auth_token.txt"
            echo -n "${{ secrets.N8N_ENCRYPTION_KEY }}" > "$DEPLOY_DIR/secrets/n8n_encryption_key.txt"
            echo -n "${{ secrets.PGADMIN_EMAIL }}" > "$DEPLOY_DIR/secrets/pgadmin_email.txt"
            echo -n "${{ secrets.PGADMIN_PASSWORD }}" > "$DEPLOY_DIR/secrets/pgadmin_password.txt"
            echo -n "${{ secrets.GRAFANA_PASSWORD }}" > "$DEPLOY_DIR/secrets/grafana_password.txt"
            echo -n "${{ secrets.TRAEFIK_DASHBOARD_AUTH }}" > "$DEPLOY_DIR/secrets/traefik_dashboard_auth.txt"
            
            # üîê CREATE CLOUDFLARE CERTIFICATES (from GitHub Secrets)
            echo "üîê Deploying Cloudflare origin certificates..."
            mkdir -p "$DEPLOY_DIR/cloudflare-certs"
            printf '%s' "${{ secrets.CLOUDFLARE_ORIGIN_CERT }}" > "$DEPLOY_DIR/cloudflare-certs/origin-cert.pem"
            printf '%s' "${{ secrets.CLOUDFLARE_ORIGIN_KEY }}" > "$DEPLOY_DIR/cloudflare-certs/origin-key.pem"
            
            # Set secure permissions on certificate and secret files
            chmod 600 "$DEPLOY_DIR/cloudflare-certs"/*.pem
            chmod 644 "$DEPLOY_DIR/secrets"/*.txt
            chmod 640 "$DEPLOY_DIR/.env.production"
            
            echo "‚úÖ Credentials injected"
            
            # Log in to GitHub Container Registry
            echo "üîê Logging into GitHub Container Registry..."
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            
            # Fix permissions on executable scripts
            chmod +x *.sh 2>/dev/null || true
            chmod +x aquatiq-gateway/*.sh 2>/dev/null || true
            
            # Pull pre-built images
            echo "üì¶ Pulling pre-built images from GitHub Container Registry..."
            docker pull ghcr.io/${{ github.repository }}/aquatiq-gateway:latest || echo "Note: Image may not exist yet"
            
            # Source production environment for docker compose
            set -a
            [ -f "$DEPLOY_DIR/.env.production" ] && source "$DEPLOY_DIR/.env.production"
            set +a
            
            # Start services with docker compose
            echo "üöÄ Starting all services (fresh installation)..."
            docker compose -f docker-compose.yml pull 2>&1 | grep -E "(Pulling|Pull complete|Status)" || true
            docker compose -f docker-compose.yml up -d 2>&1 | grep -E "(Creating|Recreate|Starting|Started)" || true
            
            # Wait for services to stabilize
            echo "‚è≥ Waiting for services to initialize..."
            sleep 15
            
            # Verify health
            echo "‚úÖ Checking service health..."
            docker compose -f docker-compose.yml ps --format "table {{.Service}}\t{{.Status}}"
            
            # Test PostgreSQL initialization
            echo "üîç Verifying PostgreSQL initialization..."
            docker compose -f docker-compose.yml logs postgres 2>&1 | grep -E "databases created|ready to accept" | tail -2 || true
            
            # Test HTTPS connectivity after Traefik is up
            echo "‚è≥ Waiting 20 seconds for Traefik to initialize..."
            sleep 20
            
            echo "üîç Testing HTTPS connectivity..."
            curl -k -I https://localhost:443/ 2>&1 | head -1 || echo "Note: Local HTTPS test may require proper hostname"
            
            echo ""
            echo "‚ú® Fresh installation completed!"
            echo "üìã NEXT STEPS:"
            echo "   1. Verify Cloudflare DNS points to VPS: ${{ secrets.VPS_HOST }}"
            echo "   2. Check services: docker compose ps"
            echo "   3. View logs: docker compose logs -f [service-name]"
            echo "   4. Test HTTPS: curl -I https://n8n.aquatiq.com"
            
            # Log out from registry
            docker logout ghcr.io || true

  notify:
    needs: fresh-install
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Installation Result
        run: |
          if [ "${{ needs.fresh-install.result }}" = "success" ]; then
            echo "‚úÖ Fresh installation completed successfully!"
            echo "Your VPS is now fully initialized with:"
            echo "  ‚Ä¢ All credentials injected from GitHub Secrets"
            echo "  ‚Ä¢ Cloudflare origin certificates deployed"
            echo "  ‚Ä¢ All 13 services running"
            echo "  ‚Ä¢ HTTPS/TLS configured"
            echo "  ‚Ä¢ Database initialized"
            exit 0
          else
            echo "‚ùå Fresh installation failed!"
            echo "Check GitHub Actions logs for details"
            exit 1
          fi
