http:
  middlewares:
    # ============================================================================
    # CLOUDFLARE SECURITY & HEADERS
    # ============================================================================
    
    # Security headers for HTTPS connections
    cloudflare-security:
      headers:
        customResponseHeaders:
          # Cloudflare Strict Mode Headers
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
    
    # ============================================================================
    # RATE LIMITING
    # ============================================================================
    
    # Global rate limiting - 100 requests per minute per IP
    global-ratelimit:
      rateLimit:
        average: 100
        period: "1m"
        burst: 50
    
    # Strict rate limiting for admin endpoints - 20 requests per minute
    admin-ratelimit:
      rateLimit:
        average: 20
        period: "1m"
        burst: 10
    
    # API rate limiting - 200 requests per minute
    api-ratelimit:
      rateLimit:
        average: 200
        period: "1m"
        burst: 100
    
    # ============================================================================
    # IP WHITELISTING
    # ============================================================================
    
    # Dynamic IP whitelist (managed by root-manager)
    # Cloudflare IPs + office networks
    dynamic-ipwhitelist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"                    # Localhost
          - "77.106.153.146/32"               # Office network
          # Note: Cloudflare IPs are trusted via forwardedHeaders in Traefik static config
    
    # ============================================================================
    # COMPRESSION & CACHING
    # ============================================================================
    
    # Enable gzip compression for responses
    compress:
      compress:
        minResponseBodyBytes: 1024
        excludedContentTypes:
          - "image/png"
          - "image/jpeg"
          - "image/webp"
          - "video/*"
        contentTypeNosniff: true
        browserXssFilter: true
    
    # Basic auth middleware (uses Docker secret)
    traefik-auth:
      basicAuth:
        usersFile: "/run/secrets/traefik_dashboard_auth"
